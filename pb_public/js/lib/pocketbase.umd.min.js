!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).PocketBase=t()}(this,function(){"use strict";class d extends Error{constructor(e){super("ClientResponseError"),this.url="",this.status=0,this.response={},this.isAbort=!1,this.originalError=null,Object.setPrototypeOf(this,d.prototype),null!==e&&"object"==typeof e&&(this.url="string"==typeof e.url?e.url:"",this.status="number"==typeof e.status?e.status:0,this.isAbort=!!e.isAbort,this.originalError=e.originalError,null!==e.response&&"object"==typeof e.response?this.response=e.response:null!==e.data&&"object"==typeof e.data?this.response=e.data:this.response={}),this.originalError||e instanceof d||(this.originalError=e),"undefined"!=typeof DOMException&&e instanceof DOMException&&(this.isAbort=!0),this.name="ClientResponseError "+this.status,this.message=this.response?.message,this.message||(this.isAbort?this.message="The request was autocancelled. You can find more info in https://github.com/pocketbase/js-sdk#auto-cancellation.":this.originalError?.cause?.message?.includes("ECONNREFUSED ::1")?this.message="Failed to connect to the PocketBase server. Try changing the SDK URL from localhost to 127.0.0.1 (https://github.com/pocketbase/js-sdk/issues/21).":this.message="Something went wrong while processing your request.")}get data(){return this.response}toJSON(){return{...this}}}const o=/^[\u0009\u0020-\u007e\u0080-\u00ff]+$/;function a(e,t,s){const i=Object.assign({},s||{}),n=i.encode||h;if(!o.test(e))throw new TypeError("argument name is invalid");s=n(t);if(s&&!o.test(s))throw new TypeError("argument val is invalid");let r=e+"="+s;if(null!=i.maxAge){const o=+i.maxAge;if(isNaN(o)||!isFinite(o))throw new TypeError("option maxAge is invalid");r+="; Max-Age="+Math.floor(o)}if(i.domain){if(!o.test(i.domain))throw new TypeError("option domain is invalid");r+="; Domain="+i.domain}if(i.path){if(!o.test(i.path))throw new TypeError("option path is invalid");r+="; Path="+i.path}if(i.expires){if(t=i.expires,!("[object Date]"===Object.prototype.toString.call(t)||t instanceof Date)||isNaN(i.expires.valueOf()))throw new TypeError("option expires is invalid");r+="; Expires="+i.expires.toUTCString()}if(i.httpOnly&&(r+="; HttpOnly"),i.secure&&(r+="; Secure"),i.priority)switch("string"==typeof i.priority?i.priority.toLowerCase():i.priority){case"low":r+="; Priority=Low";break;case"medium":r+="; Priority=Medium";break;case"high":r+="; Priority=High";break;default:throw new TypeError("option priority is invalid")}if(i.sameSite)switch("string"==typeof i.sameSite?i.sameSite.toLowerCase():i.sameSite){case!0:r+="; SameSite=Strict";break;case"lax":r+="; SameSite=Lax";break;case"strict":r+="; SameSite=Strict";break;case"none":r+="; SameSite=None";break;default:throw new TypeError("option sameSite is invalid")}return r}function c(e){return-1!==e.indexOf("%")?decodeURIComponent(e):e}function h(e){return encodeURIComponent(e)}var e="undefined"!=typeof navigator&&"ReactNative"===navigator.product||"undefined"!=typeof global&&global.HermesInternal;let s;function l(e){if(e)try{var t=decodeURIComponent(s(e.split(".")[1]).split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join(""));return JSON.parse(t)||{}}catch(e){}return{}}function u(e,t=0){e=l(e);return!(0<Object.keys(e).length&&(!e.exp||e.exp-t>Date.now()/1e3))}s="function"!=typeof atob||e?e=>{let t=String(e).replace(/=+$/,"");if(t.length%4==1)throw new Error("'atob' failed: The string to be decoded is not correctly encoded.");for(var s,i,n=0,r=0,o="";i=t.charAt(r++);~i&&(s=n%4?64*s+i:i,n++%4)&&(o+=String.fromCharCode(255&s>>(-2*n&6))))i="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=".indexOf(i);return o}:atob;const p="pb_auth";class i extends class{constructor(){this.baseToken="",this.baseModel=null,this._onChangeCallbacks=[]}get token(){return this.baseToken}get model(){return this.baseModel}get isValid(){return!u(this.token)}get isAdmin(){return"admin"===l(this.token).type}get isAuthRecord(){return"authRecord"===l(this.token).type}save(e,t){this.baseToken=e||"",this.baseModel=t||null,this.triggerChange()}clear(){this.baseToken="",this.baseModel=null,this.triggerChange()}loadFromCookie(e,t=p){t=function(s,i){const n={};if("string"!=typeof s)return n;const r=Object.assign({},i||{}).decode||c;let e=0;for(;e<s.length;){const i=s.indexOf("=",e);if(-1===i)break;let t=s.indexOf(";",e);if(-1===t)t=s.length;else if(t<i){e=s.lastIndexOf(";",i-1)+1;continue}var o=s.slice(e,i).trim();if(void 0===n[o]){let e=s.slice(i+1,t).trim();34===e.charCodeAt(0)&&(e=e.slice(1,-1));try{n[o]=r(e)}catch(s){n[o]=e}}e=t+1}return n}(e||"")[t]||"";let s={};try{null!==typeof(s=JSON.parse(t))&&"object"==typeof s&&!Array.isArray(s)||(s={})}catch(e){}this.save(s.token||"",s.model||null)}exportToCookie(e,t=p){const s={secure:!0,sameSite:!0,httpOnly:!0,path:"/"},i=l(this.token),n=(s.expires=i?.exp?new Date(1e3*i.exp):new Date("1970-01-01"),e=Object.assign({},s,e),{token:this.token,model:this.model?JSON.parse(JSON.stringify(this.model)):null});let r=a(t,JSON.stringify(n),e);var o="undefined"!=typeof Blob?new Blob([r]).size:r.length;if(n.model&&4096<o){n.model={id:n?.model?.id,email:n?.model?.email};const s=["collectionId","username","verified"];for(const e in this.model)s.includes(e)&&(n.model[e]=this.model[e]);r=a(t,JSON.stringify(n),e)}return r}onChange(t,e=!1){return this._onChangeCallbacks.push(t),e&&t(this.token,this.model),()=>{for(let e=this._onChangeCallbacks.length-1;0<=e;e--)if(this._onChangeCallbacks[e]==t)return delete this._onChangeCallbacks[e],void this._onChangeCallbacks.splice(e,1)}}triggerChange(){for(const e of this._onChangeCallbacks)e&&e(this.token,this.model)}}{constructor(e="pocketbase_auth"){super(),this.storageFallback={},this.storageKey=e,this._bindStorageEvent()}get token(){return(this._storageGet(this.storageKey)||{}).token||""}get model(){return(this._storageGet(this.storageKey)||{}).model||null}save(e,t){this._storageSet(this.storageKey,{token:e,model:t}),super.save(e,t)}clear(){this._storageRemove(this.storageKey),super.clear()}_storageGet(e){if("undefined"!=typeof window&&window?.localStorage){var t=window.localStorage.getItem(e)||"";try{return JSON.parse(t)}catch(e){return t}}return this.storageFallback[e]}_storageSet(t,s){if("undefined"!=typeof window&&window?.localStorage){let e=s;"string"!=typeof s&&(e=JSON.stringify(s)),window.localStorage.setItem(t,e)}else this.storageFallback[t]=s}_storageRemove(e){"undefined"!=typeof window&&window?.localStorage&&window.localStorage?.removeItem(e),delete this.storageFallback[e]}_bindStorageEvent(){"undefined"!=typeof window&&window?.localStorage&&window.addEventListener&&window.addEventListener("storage",e=>{e.key==this.storageKey&&(e=this._storageGet(this.storageKey)||{},super.save(e.token||"",e.model||null))})}}class t{constructor(e){this.client=e}}class n extends t{async getAll(e){return e=Object.assign({method:"GET"},e),this.client.send("/api/settings",e)}async update(e,t){return t=Object.assign({method:"PATCH",body:e},t),this.client.send("/api/settings",t)}async testS3(e="storage",t){return t=Object.assign({method:"POST",body:{filesystem:e}},t),this.client.send("/api/settings/test/s3",t).then(()=>!0)}async testEmail(e,t,s){return s=Object.assign({method:"POST",body:{email:e,template:t}},s),this.client.send("/api/settings/test/email",s).then(()=>!0)}async generateAppleClientSecret(e,t,s,i,n,r){return r=Object.assign({method:"POST",body:{clientId:e,teamId:t,keyId:s,privateKey:i,duration:n}},r),this.client.send("/api/settings/apple/generate-client-secret",r)}}class r extends t{decode(e){return e}async getFullList(e,t){if("number"==typeof e)return this._getFullList(e,t);let s=500;return(t=Object.assign({},e,t)).batch&&(s=t.batch,delete t.batch),this._getFullList(s,t)}async getList(e=1,t=30,s){return(s=Object.assign({method:"GET"},s)).query=Object.assign({page:e,perPage:t},s.query),this.client.send(this.baseCrudPath,s).then(e=>(e.items=e.items?.map(e=>this.decode(e))||[],e))}async getFirstListItem(e,t){return(t=Object.assign({requestKey:"one_by_filter_"+this.baseCrudPath+"_"+e},t)).query=Object.assign({filter:e,skipTotal:1},t.query),this.getList(1,1,t).then(e=>{if(e?.items?.length)return e.items[0];throw new d({status:404,response:{code:404,message:"The requested resource wasn't found.",data:{}}})})}async getOne(e,t){if(e)return t=Object.assign({method:"GET"},t),this.client.send(this.baseCrudPath+"/"+encodeURIComponent(e),t).then(e=>this.decode(e));throw new d({url:this.client.buildUrl(this.baseCrudPath+"/"),status:404,response:{code:404,message:"Missing required record id.",data:{}}})}async create(e,t){return t=Object.assign({method:"POST",body:e},t),this.client.send(this.baseCrudPath,t).then(e=>this.decode(e))}async update(e,t,s){return s=Object.assign({method:"PATCH",body:t},s),this.client.send(this.baseCrudPath+"/"+encodeURIComponent(e),s).then(e=>this.decode(e))}async delete(e,t){return t=Object.assign({method:"DELETE"},t),this.client.send(this.baseCrudPath+"/"+encodeURIComponent(e),t).then(()=>!0)}_getFullList(e=500,t){(t=t||{}).query=Object.assign({skipTotal:1},t.query);let i=[],n=async s=>this.getList(s,e||500,t).then(e=>{var t=e.items;return i=i.concat(t),t.length==e.perPage?n(s+1):i});return n(1)}}function f(e,t,s,i){var n=void 0!==i;return n||void 0!==s?n?(console.warn(e),t.body=Object.assign({},t.body,s),t.query=Object.assign({},t.query,i),t):Object.assign(t,s):t}function m(e){e._resetAutoRefresh?.()}class b extends r{get baseCrudPath(){return"/api/admins"}async update(e,t,s){return super.update(e,t,s).then(e=>(this.client.authStore.model?.id===e.id&&void 0===this.client.authStore.model?.collectionId&&this.client.authStore.save(this.client.authStore.token,e),e))}async delete(t,e){return super.delete(t,e).then(e=>(e&&this.client.authStore.model?.id===t&&void 0===this.client.authStore.model?.collectionId&&this.client.authStore.clear(),e))}authResponse(e){var t=this.decode(e?.admin||{});return e?.token&&e?.admin&&this.client.authStore.save(e.token,t),Object.assign({},e,{token:e?.token||"",admin:t})}async authWithPassword(e,t,s,i){let n={method:"POST",body:{identity:e,password:t}};s=(n=f("This form of authWithPassword(email, pass, body?, query?) is deprecated. Consider replacing it with authWithPassword(email, pass, options?).",n,s,i)).autoRefreshThreshold,delete n.autoRefreshThreshold,n.autoRefresh||m(this.client),i=await this.client.send(this.baseCrudPath+"/auth-with-password",n),i=this.authResponse(i);if(s){var o=this.client,a=s,c=()=>this.authRefresh({autoRefresh:!0}),h=()=>this.authWithPassword(e,t,Object.assign({autoRefresh:!0},n));m(o);const l=o.beforeSend,r=o.authStore.model,d=o.authStore.onChange((e,t)=>{e&&t?.id==r?.id&&(!t?.collectionId&&!r?.collectionId||t?.collectionId==r?.collectionId)||m(o)});o._resetAutoRefresh=function(){d(),o.beforeSend=l,delete o._resetAutoRefresh},o.beforeSend=async(e,t)=>{var s,i=o.authStore.token;if(t.query?.autoRefresh)return l?l(e,t):{url:e,sendOptions:t};let n=o.authStore.isValid;if(n&&u(o.authStore.token,a))try{await c()}catch(e){n=!1}n||await h();const r=t.headers||{};for(s in r)if("authorization"==s.toLowerCase()&&i==r[s]&&o.authStore.token){r[s]=o.authStore.token;break}return t.headers=r,l?l(e,t):{url:e,sendOptions:t}}}return i}async authRefresh(e,t){e=f("This form of authRefresh(body?, query?) is deprecated. Consider replacing it with authRefresh(options?).",{method:"POST"},e,t);return this.client.send(this.baseCrudPath+"/auth-refresh",e).then(this.authResponse.bind(this))}async requestPasswordReset(e,t,s){e=f("This form of requestPasswordReset(email, body?, query?) is deprecated. Consider replacing it with requestPasswordReset(email, options?).",{method:"POST",body:{email:e}},t,s);return this.client.send(this.baseCrudPath+"/request-password-reset",e).then(()=>!0)}async confirmPasswordReset(e,t,s,i,n){e=f("This form of confirmPasswordReset(resetToken, password, passwordConfirm, body?, query?) is deprecated. Consider replacing it with confirmPasswordReset(resetToken, password, passwordConfirm, options?).",{method:"POST",body:{token:e,password:t,passwordConfirm:s}},i,n);return this.client.send(this.baseCrudPath+"/confirm-password-reset",e).then(()=>!0)}}const g=["requestKey","$cancelKey","$autoCancel","fetch","headers","body","query","params","cache","credentials","headers","integrity","keepalive","method","mode","redirect","referrer","referrerPolicy","signal","window"];function y(e){if(e)for(var t in e.query=e.query||{},e)g.includes(t)||(e.query[t]=e[t],delete e[t])}class w extends t{constructor(){super(...arguments),this.clientId="",this.eventSource=null,this.subscriptions={},this.lastSentSubscriptions=[],this.maxConnectTimeout=15e3,this.reconnectAttempts=0,this.maxReconnectAttempts=1/0,this.predefinedReconnectIntervals=[200,300,500,1e3,1200,1500,2e3],this.pendingConnects=[]}get isConnected(){return!!this.eventSource&&!!this.clientId&&!this.pendingConnects.length}async subscribe(e,s,t){if(!e)throw new Error("topic must be set.");let i=e;if(t){y(t);const e="options="+encodeURIComponent(JSON.stringify({query:t.query,headers:t.headers}));i+=(i.includes("?")?"&":"?")+e}function n(e){let t;try{t=JSON.parse(e?.data)}catch{}s(t||{})}return this.subscriptions[i]||(this.subscriptions[i]=[]),this.subscriptions[i].push(n),this.isConnected?1===this.subscriptions[i].length?await this.submitSubscriptions():this.eventSource?.addEventListener(i,n):await this.connect(),async()=>this.unsubscribeByTopicAndListener(e,n)}async unsubscribe(e){let t=!1;if(e){for(var s in this.getSubscriptionsByTopic(e))if(this.hasSubscriptionListeners(s)){for(var i of this.subscriptions[s])this.eventSource?.removeEventListener(s,i);delete this.subscriptions[s],t=t||!0}}else this.subscriptions={};this.hasSubscriptionListeners()?t&&await this.submitSubscriptions():this.disconnect()}async unsubscribeByPrefix(e){let t=!1;for(var s in this.subscriptions)if((s+"?").startsWith(e)){t=!0;for(var i of this.subscriptions[s])this.eventSource?.removeEventListener(s,i);delete this.subscriptions[s]}t&&(this.hasSubscriptionListeners()?await this.submitSubscriptions():this.disconnect())}async unsubscribeByTopicAndListener(e,s){let i=!1;for(var n in this.getSubscriptionsByTopic(e))if(Array.isArray(this.subscriptions[n])&&this.subscriptions[n].length){let t=!1;for(let e=this.subscriptions[n].length-1;0<=e;e--)this.subscriptions[n][e]===s&&(t=!0,delete this.subscriptions[n][e],this.subscriptions[n].splice(e,1),this.eventSource?.removeEventListener(n,s));t&&(this.subscriptions[n].length||delete this.subscriptions[n],i||this.hasSubscriptionListeners(n)||(i=!0))}this.hasSubscriptionListeners()?i&&await this.submitSubscriptions():this.disconnect()}hasSubscriptionListeners(e){if(this.subscriptions=this.subscriptions||{},e)return!!this.subscriptions[e]?.length;for(var t in this.subscriptions)if(this.subscriptions[t]?.length)return!0;return!1}async submitSubscriptions(){if(this.clientId)return this.addAllSubscriptionListeners(),this.lastSentSubscriptions=this.getNonEmptySubscriptionKeys(),this.client.send("/api/realtime",{method:"POST",body:{clientId:this.clientId,subscriptions:this.lastSentSubscriptions},requestKey:this.getSubscriptionsCancelKey()}).catch(e=>{if(!e?.isAbort)throw e})}getSubscriptionsCancelKey(){return"realtime_"+this.clientId}getSubscriptionsByTopic(e){const t={};for(var s in e=e.includes("?")?e:e+"?",this.subscriptions)(s+"?").startsWith(e)&&(t[s]=this.subscriptions[s]);return t}getNonEmptySubscriptionKeys(){const e=[];for(var t in this.subscriptions)this.subscriptions[t].length&&e.push(t);return e}addAllSubscriptionListeners(){if(this.eventSource)for(var e in this.removeAllSubscriptionListeners(),this.subscriptions)for(var t of this.subscriptions[e])this.eventSource.addEventListener(e,t)}removeAllSubscriptionListeners(){if(this.eventSource)for(var e in this.subscriptions)for(var t of this.subscriptions[e])this.eventSource.removeEventListener(e,t)}async connect(){if(!(0<this.reconnectAttempts))return new Promise((e,t)=>{this.pendingConnects.push({resolve:e,reject:t}),1<this.pendingConnects.length||this.initConnect()})}initConnect(){this.disconnect(!0),clearTimeout(this.connectTimeoutId),this.connectTimeoutId=setTimeout(()=>{this.connectErrorHandler(new Error("EventSource connect took too long."))},this.maxConnectTimeout),this.eventSource=new EventSource(this.client.buildUrl("/api/realtime")),this.eventSource.onerror=e=>{this.connectErrorHandler(new Error("Failed to establish realtime connection."))},this.eventSource.addEventListener("PB_CONNECT",n=>{this.clientId=n?.lastEventId,this.submitSubscriptions().then(async()=>{let e=3;for(;this.hasUnsentSubscriptions()&&0<e;)e--,await this.submitSubscriptions()}).then(()=>{for(var e of this.pendingConnects)e.resolve();this.pendingConnects=[],this.reconnectAttempts=0,clearTimeout(this.reconnectTimeoutId),clearTimeout(this.connectTimeoutId);var t,s=this.getSubscriptionsByTopic("PB_CONNECT");for(t in s)for(var i of s[t])i(n)}).catch(e=>{this.clientId="",this.connectErrorHandler(e)})})}hasUnsentSubscriptions(){var e=this.getNonEmptySubscriptionKeys();if(e.length!=this.lastSentSubscriptions.length)return!0;for(const t of e)if(!this.lastSentSubscriptions.includes(t))return!0;return!1}connectErrorHandler(e){if(clearTimeout(this.connectTimeoutId),clearTimeout(this.reconnectTimeoutId),!this.clientId&&!this.reconnectAttempts||this.reconnectAttempts>this.maxReconnectAttempts){for(var t of this.pendingConnects)t.reject(new d(e));return this.pendingConnects=[],void this.disconnect()}this.disconnect(!0);var s=this.predefinedReconnectIntervals[this.reconnectAttempts]||this.predefinedReconnectIntervals[this.predefinedReconnectIntervals.length-1];this.reconnectAttempts++,this.reconnectTimeoutId=setTimeout(()=>{this.initConnect()},s)}disconnect(e=!1){if(clearTimeout(this.connectTimeoutId),clearTimeout(this.reconnectTimeoutId),this.removeAllSubscriptionListeners(),this.client.cancelRequest(this.getSubscriptionsCancelKey()),this.eventSource?.close(),this.eventSource=null,this.clientId="",!e){this.reconnectAttempts=0;for(var t of this.pendingConnects)t.resolve();this.pendingConnects=[]}}}class S extends r{constructor(e,t){super(e),this.collectionIdOrName=t}get baseCrudPath(){return this.baseCollectionPath+"/records"}get baseCollectionPath(){return"/api/collections/"+encodeURIComponent(this.collectionIdOrName)}async subscribe(e,t,s){if(!e)throw new Error("Missing topic.");if(t)return this.client.realtime.subscribe(this.collectionIdOrName+"/"+e,t,s);throw new Error("Missing subscription callback.")}async unsubscribe(e){return e?this.client.realtime.unsubscribe(this.collectionIdOrName+"/"+e):this.client.realtime.unsubscribeByPrefix(this.collectionIdOrName)}async getFullList(e,t){if("number"==typeof e)return super.getFullList(e,t);e=Object.assign({},e,t);return super.getFullList(e)}async getList(e=1,t=30,s){return super.getList(e,t,s)}async getFirstListItem(e,t){return super.getFirstListItem(e,t)}async getOne(e,t){return super.getOne(e,t)}async create(e,t){return super.create(e,t)}async update(e,t,s){return super.update(e,t,s).then(e=>(this.client.authStore.model?.id!==e?.id||this.client.authStore.model?.collectionId!==this.collectionIdOrName&&this.client.authStore.model?.collectionName!==this.collectionIdOrName||this.client.authStore.save(this.client.authStore.token,e),e))}async delete(t,e){return super.delete(t,e).then(e=>(!e||this.client.authStore.model?.id!==t||this.client.authStore.model?.collectionId!==this.collectionIdOrName&&this.client.authStore.model?.collectionName!==this.collectionIdOrName||this.client.authStore.clear(),e))}authResponse(e){var t=this.decode(e?.record||{});return this.client.authStore.save(e?.token,t),Object.assign({},e,{token:e?.token||"",record:t})}async listAuthMethods(e){return e=Object.assign({method:"GET"},e),this.client.send(this.baseCollectionPath+"/auth-methods",e).then(e=>Object.assign({},e,{usernamePassword:!!e?.usernamePassword,emailPassword:!!e?.emailPassword,authProviders:Array.isArray(e?.authProviders)?e?.authProviders:[]}))}async authWithPassword(e,t,s,i){e=f("This form of authWithPassword(usernameOrEmail, pass, body?, query?) is deprecated. Consider replacing it with authWithPassword(usernameOrEmail, pass, options?).",{method:"POST",body:{identity:e,password:t}},s,i);return this.client.send(this.baseCollectionPath+"/auth-with-password",e).then(e=>this.authResponse(e))}async authWithOAuth2Code(e,t,s,i,n,r,o){e=f("This form of authWithOAuth2Code(provider, code, codeVerifier, redirectUrl, createData?, body?, query?) is deprecated. Consider replacing it with authWithOAuth2Code(provider, code, codeVerifier, redirectUrl, createData?, options?).",{method:"POST",body:{provider:e,code:t,codeVerifier:s,redirectUrl:i,createData:n}},r,o);return this.client.send(this.baseCollectionPath+"/auth-with-oauth2",e).then(e=>this.authResponse(e))}async authWithOAuth2(...e){if(1<e.length||"string"==typeof e?.[0])return console.warn("PocketBase: This form of authWithOAuth2() is deprecated and may get removed in the future. Please replace with authWithOAuth2Code() OR use the authWithOAuth2() realtime form as shown in https://pocketbase.io/docs/authentication/#oauth2-integration."),this.authWithOAuth2Code(e?.[0]||"",e?.[1]||"",e?.[2]||"",e?.[3]||"",e?.[4]||{},e?.[5]||{},e?.[6]||{});const r=e?.[0]||{},o=(await this.listAuthMethods()).authProviders.find(e=>e.name===r.provider);if(!o)throw new d(new Error(`Missing or invalid provider "${r.provider}".`));const a=this.client.buildUrl("/api/oauth2-redirect"),c=new w(this.client);let h=null;function l(){h?.close(),c.unsubscribe()}return r.urlCallback||(h=C(void 0)),new Promise(async(s,i)=>{try{await c.subscribe("@oauth2",async e=>{var t=c.clientId;try{if(!e.state||t!==e.state)throw new Error("State parameters don't match.");if(e.error||!e.code)throw new Error("OAuth2 redirect error or missing code: "+e.error);const c=Object.assign({},r),i=(delete c.provider,delete c.scopes,delete c.createData,delete c.urlCallback,await this.authWithOAuth2Code(o.name,e.code,o.codeVerifier,a,r.createData,c));s(i)}catch(e){i(new d(e))}l()});const n={state:c.clientId};r.scopes?.length&&(n.scope=r.scopes.join(" "));var t=this._replaceQueryParams(o.authUrl+a,n);let e=r.urlCallback||function(e){h?h.location.href=e:h=C(e)};await e(t)}catch(s){l(),i(new d(s))}})}async authRefresh(e,t){e=f("This form of authRefresh(body?, query?) is deprecated. Consider replacing it with authRefresh(options?).",{method:"POST"},e,t);return this.client.send(this.baseCollectionPath+"/auth-refresh",e).then(e=>this.authResponse(e))}async requestPasswordReset(e,t,s){e=f("This form of requestPasswordReset(email, body?, query?) is deprecated. Consider replacing it with requestPasswordReset(email, options?).",{method:"POST",body:{email:e}},t,s);return this.client.send(this.baseCollectionPath+"/request-password-reset",e).then(()=>!0)}async confirmPasswordReset(e,t,s,i,n){e=f("This form of confirmPasswordReset(token, password, passwordConfirm, body?, query?) is deprecated. Consider replacing it with confirmPasswordReset(token, password, passwordConfirm, options?).",{method:"POST",body:{token:e,password:t,passwordConfirm:s}},i,n);return this.client.send(this.baseCollectionPath+"/confirm-password-reset",e).then(()=>!0)}async requestVerification(e,t,s){e=f("This form of requestVerification(email, body?, query?) is deprecated. Consider replacing it with requestVerification(email, options?).",{method:"POST",body:{email:e}},t,s);return this.client.send(this.baseCollectionPath+"/request-verification",e).then(()=>!0)}async confirmVerification(s,e,t){e=f("This form of confirmVerification(token, body?, query?) is deprecated. Consider replacing it with confirmVerification(token, options?).",{method:"POST",body:{token:s}},e,t);return this.client.send(this.baseCollectionPath+"/confirm-verification",e).then(()=>{const e=l(s),t=this.client.authStore.model;return t&&!t.verified&&t.id===e.id&&t.collectionId===e.collectionId&&(t.verified=!0,this.client.authStore.save(this.client.authStore.token,t)),!0})}async requestEmailChange(e,t,s){e=f("This form of requestEmailChange(newEmail, body?, query?) is deprecated. Consider replacing it with requestEmailChange(newEmail, options?).",{method:"POST",body:{newEmail:e}},t,s);return this.client.send(this.baseCollectionPath+"/request-email-change",e).then(()=>!0)}async confirmEmailChange(s,e,t,i){e=f("This form of confirmEmailChange(token, password, body?, query?) is deprecated. Consider replacing it with confirmEmailChange(token, password, options?).",{method:"POST",body:{token:s,password:e}},t,i);return this.client.send(this.baseCollectionPath+"/confirm-email-change",e).then(()=>{var e=l(s),t=this.client.authStore.model;return t&&t.id===e.id&&t.collectionId===e.collectionId&&this.client.authStore.clear(),!0})}async listExternalAuths(e,t){return t=Object.assign({method:"GET"},t),this.client.send(this.baseCrudPath+"/"+encodeURIComponent(e)+"/external-auths",t)}async unlinkExternalAuth(e,t,s){return s=Object.assign({method:"DELETE"},s),this.client.send(this.baseCrudPath+"/"+encodeURIComponent(e)+"/external-auths/"+encodeURIComponent(t),s).then(()=>!0)}_replaceQueryParams(e,t={}){let s=e,i="";0<=e.indexOf("?")&&(s=e.substring(0,e.indexOf("?")),i=e.substring(e.indexOf("?")+1));const n={},r=i.split("&");for(const e of r)if(""!=e){const t=e.split("=");n[decodeURIComponent(t[0].replace(/\+/g," "))]=decodeURIComponent((t[1]||"").replace(/\+/g," "))}for(var o in t)t.hasOwnProperty(o)&&(null==t[o]?delete n[o]:n[o]=t[o]);for(var a in i="",n)n.hasOwnProperty(a)&&(""!=i&&(i+="&"),i+=encodeURIComponent(a.replace(/%20/g,"+"))+"="+encodeURIComponent(n[a].replace(/%20/g,"+")));return""!=i?s+"?"+i:s}}function C(e){if("undefined"==typeof window||!window?.open)throw new d(new Error("Not in a browser context - please pass a custom urlCallback function."));let t=1024,s=768,i=window.innerWidth,n=window.innerHeight;t=t>i?i:t,s=s>n?n:s;var r=i/2-t/2,o=n/2-s/2;return window.open(e,"popup_window","width="+t+",height="+s+",top="+o+",left="+r+",resizable,menubar=no")}class v extends r{get baseCrudPath(){return"/api/collections"}async import(e,t=!1,s){return s=Object.assign({method:"PUT",body:{collections:e,deleteMissing:t}},s),this.client.send(this.baseCrudPath+"/import",s).then(()=>!0)}}class O extends t{async getList(e=1,t=30,s){return(s=Object.assign({method:"GET"},s)).query=Object.assign({page:e,perPage:t},s.query),this.client.send("/api/logs",s)}async getOne(e,t){if(e)return t=Object.assign({method:"GET"},t),this.client.send("/api/logs/"+encodeURIComponent(e),t);throw new d({url:this.client.buildUrl("/api/logs/"),status:404,response:{code:404,message:"Missing required log id.",data:{}}})}async getStats(e){return e=Object.assign({method:"GET"},e),this.client.send("/api/logs/stats",e)}}class T extends t{async check(e){return e=Object.assign({method:"GET"},e),this.client.send("/api/health",e)}}class P extends t{getUrl(e,t,s={}){if(!t||!e?.id||!e?.collectionId&&!e?.collectionName)return"";const i=[];i.push("api"),i.push("files"),i.push(encodeURIComponent(e.collectionId||e.collectionName)),i.push(encodeURIComponent(e.id)),i.push(encodeURIComponent(t));let n=this.client.buildUrl(i.join("/"));if(Object.keys(s).length){!1===s.download&&delete s.download;const e=new URLSearchParams(s);n+=(n.includes("?")?"&":"?")+e}return n}async getToken(e){return e=Object.assign({method:"POST"},e),this.client.send("/api/files/token",e).then(e=>e?.token||"")}}class k extends t{async getFullList(e){return e=Object.assign({method:"GET"},e),this.client.send("/api/backups",e)}async create(e,t){return t=Object.assign({method:"POST",body:{name:e}},t),this.client.send("/api/backups",t).then(()=>!0)}async upload(e,t){return t=Object.assign({method:"POST",body:e},t),this.client.send("/api/backups/upload",t).then(()=>!0)}async delete(e,t){return t=Object.assign({method:"DELETE"},t),this.client.send("/api/backups/"+encodeURIComponent(e),t).then(()=>!0)}async restore(e,t){return t=Object.assign({method:"POST"},t),this.client.send(`/api/backups/${encodeURIComponent(e)}/restore`,t).then(()=>!0)}getDownloadUrl(e,t){return this.client.buildUrl(`/api/backups/${encodeURIComponent(t)}?token=`+encodeURIComponent(e))}}return class{constructor(e="/",t,s="en-US"){this.cancelControllers={},this.recordServices={},this.enableAutoCancellation=!0,this.baseUrl=e,this.lang=s,this.authStore=t||new i,this.admins=new b(this),this.collections=new v(this),this.files=new P(this),this.logs=new O(this),this.settings=new n(this),this.realtime=new w(this),this.health=new T(this),this.backups=new k(this)}collection(e){return this.recordServices[e]||(this.recordServices[e]=new S(this,e)),this.recordServices[e]}autoCancellation(e){return this.enableAutoCancellation=!!e,this}cancelRequest(e){return this.cancelControllers[e]&&(this.cancelControllers[e].abort(),delete this.cancelControllers[e]),this}cancelAllRequests(){for(var e in this.cancelControllers)this.cancelControllers[e].abort();return this.cancelControllers={},this}filter(t,s){if(!s)return t;for(var i in s){let e=s[i];switch(typeof e){case"boolean":case"number":e=""+e;break;case"string":e="'"+e.replace(/'/g,"\\'")+"'";break;default:e=null===e?"null":e instanceof Date?"'"+e.toISOString().replace("T"," ")+"'":"'"+JSON.stringify(e).replace(/'/g,"\\'")+"'"}t=t.replaceAll("{:"+i+"}",e)}return t}getFileUrl(e,t,s={}){return this.files.getUrl(e,t,s)}buildUrl(e){let t=this.baseUrl;return"undefined"==typeof window||!window.location||t.startsWith("https://")||t.startsWith("http://")||(t=window.location.origin?.endsWith("/")?window.location.origin.substring(0,window.location.origin.length-1):window.location.origin||"",this.baseUrl.startsWith("/")||(t=(t+=window.location.pathname||"/")+(t.endsWith("/")?"":"/")),t+=this.baseUrl),t=e?(t+=t.endsWith("/")?"":"/")+(e.startsWith("/")?e.substring(1):e):t}async send(e,t){t=this.initSendOptions(e,t);let s=this.buildUrl(e);if(this.beforeSend){const e=Object.assign({},await this.beforeSend(s,t));void 0!==e.url||void 0!==e.options?(s=e.url||s,t=e.options||t):Object.keys(e).length&&(t=e,console?.warn&&console.warn("Deprecated format of beforeSend return: please use `return { url, options }`, instead of `return options`."))}if(void 0!==t.query){const e=this.serializeQueryParams(t.query);e&&(s+=(s.includes("?")?"&":"?")+e),delete t.query}return"application/json"==this.getHeader(t.headers,"Content-Type")&&t.body&&"string"!=typeof t.body&&(t.body=JSON.stringify(t.body)),(t.fetch||fetch)(s,t).then(async e=>{let t={};try{t=await e.json()}catch(e){}if(this.afterSend&&(t=await this.afterSend(e,t)),400<=e.status)throw new d({url:e.url,status:e.status,data:t});return t}).catch(e=>{throw new d(e)})}initSendOptions(e,t){var s;return(t=Object.assign({method:"GET"},t)).body=this.convertToFormDataIfNeeded(t.body),y(t),t.query=Object.assign({},t.params,t.query),void 0===t.requestKey&&(!1===t.$autoCancel||!1===t.query.$autoCancel?t.requestKey=null:(t.$cancelKey||t.query.$cancelKey)&&(t.requestKey=t.$cancelKey||t.query.$cancelKey)),delete t.$autoCancel,delete t.query.$autoCancel,delete t.$cancelKey,delete t.query.$cancelKey,null!==this.getHeader(t.headers,"Content-Type")||this.isFormData(t.body)||(t.headers=Object.assign({},t.headers,{"Content-Type":"application/json"})),null===this.getHeader(t.headers,"Accept-Language")&&(t.headers=Object.assign({},t.headers,{"Accept-Language":this.lang})),this.authStore.token&&null===this.getHeader(t.headers,"Authorization")&&(t.headers=Object.assign({},t.headers,{Authorization:this.authStore.token})),this.enableAutoCancellation&&null!==t.requestKey&&(e=t.requestKey||(t.method||"GET")+e,delete t.requestKey,this.cancelRequest(e),s=new AbortController,this.cancelControllers[e]=s,t.signal=s.signal),t}convertToFormDataIfNeeded(e){if("undefined"==typeof FormData||void 0===e||"object"!=typeof e||null===e||this.isFormData(e)||!this.hasBlobField(e))return e;const t=new FormData;for(const n in e){var s=e[n];if("object"!=typeof s||this.hasBlobField({data:s})){const e=Array.isArray(s)?s:[s];for(var i of e)t.append(n,i)}else{let e={};e[n]=s,t.append("@jsonPayload",JSON.stringify(e))}}return t}hasBlobField(e){for(const s in e){var t=Array.isArray(e[s])?e[s]:[e[s]];for(const e of t)if("undefined"!=typeof Blob&&e instanceof Blob||"undefined"!=typeof File&&e instanceof File)return!0}return!1}getHeader(e,t){for(var s in e=e||{},t=t.toLowerCase(),e)if(s.toLowerCase()==t)return e[s];return null}isFormData(e){return e&&("FormData"===e.constructor.name||"undefined"!=typeof FormData&&e instanceof FormData)}serializeQueryParams(e){const t=[];for(const s in e)if(null!==e[s]){const i=e[s],n=encodeURIComponent(s);if(Array.isArray(i))for(const e of i)t.push(n+"="+encodeURIComponent(e));else i instanceof Date?t.push(n+"="+encodeURIComponent(i.toISOString())):null!==typeof i&&"object"==typeof i?t.push(n+"="+encodeURIComponent(JSON.stringify(i))):t.push(n+"="+encodeURIComponent(i))}return t.join("&")}}});